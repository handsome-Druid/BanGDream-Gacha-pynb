name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v* æ ¼å¼çš„æ ‡ç­¾ï¼ˆå¦‚ v1.3.4ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.9'
  CONDA_ENV: gacha-env

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: ${{ env.PYTHON_VERSION }}
        environment-file: environment.yml
        activate-environment: ${{ env.CONDA_ENV }}
        
    - name: Install additional dependencies
      shell: pwsh
      run: |
        conda activate ${{ env.CONDA_ENV }}
        # ç¡®ä¿ PyQt5 å·¥å…·å¯ç”¨
        pip install pyqt5-tools pyinstaller
        
    - name: Generate UI and resource files
      shell: pwsh
      run: |
        conda activate ${{ env.CONDA_ENV }}
        # ç”Ÿæˆ UI æ–‡ä»¶
        if (Test-Path ".\gacha_gui.ui") {
          pyuic5 .\gacha_gui.ui -x -o .\Ui_gacha_gui.py
          Write-Host "âœ“ UI file generated"
        }
        # ç”Ÿæˆèµ„æºæ–‡ä»¶
        if (Test-Path ".\res.qrc") {
          pyrcc5 .\res.qrc -o .\res_rc.py
          Write-Host "âœ“ Resource file generated"
        }
        
    - name: Build executable with PyInstaller
      shell: pwsh
      run: |
        conda activate ${{ env.CONDA_ENV }}
        pyinstaller --clean .\release.spec
        Write-Host "âœ“ Executable built"
        
    - name: Verify build output
      shell: pwsh
      run: |
        $exePath = ".\dist\release.exe"
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length
          Write-Host "âœ“ Executable found: $exePath ($([math]::Round($fileSize/1MB, 2)) MB)"
        } else {
          Write-Error "âœ— Executable not found at $exePath"
          exit 1
        }
        
    - name: Create self-signed certificate and sign executable
      shell: pwsh
      run: |
        $exePath = ".\dist\release.exe"
        if (Test-Path $exePath) {
          try {
            # åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼ˆä»…ç”¨äºæ ‡è¯†ï¼Œä¸èƒ½å®Œå…¨æ¶ˆé™¤ SmartScreen è­¦å‘Šï¼‰
            $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=BanGDream-Gacha Developer" -KeySpec Signature -KeyLength 2048 -Provider "Microsoft Enhanced RSA and AES Cryptographic Provider" -CertStoreLocation "Cert:\CurrentUser\My" -KeyUsage DigitalSignature -NotAfter (Get-Date).AddYears(1)
            
            # ç­¾åå¯æ‰§è¡Œæ–‡ä»¶
            $result = Set-AuthenticodeSignature -FilePath $exePath -Certificate $cert -HashAlgorithm SHA256
            
            if ($result.Status -eq "Valid" -or $result.Status -eq "UnknownError") {
              Write-Host "âœ“ Executable signed successfully"
              Write-Host "  Status: $($result.Status)"
              Write-Host "  Signer: $($result.SignerCertificate.Subject)"
            } else {
              Write-Warning "âš  Signing completed with status: $($result.Status)"
            }
          } catch {
            Write-Warning "âš  Code signing failed: $($_.Exception.Message)"
            Write-Host "Continuing without signature..."
          }
        }
        
    - name: Prepare release artifacts
      shell: pwsh
      run: |
        # åˆ›å»ºå‘å¸ƒæ–‡ä»¶å¤¹
        New-Item -ItemType Directory -Force -Path ".\release-files"
        
        # å¤åˆ¶ä¸»ç¨‹åº
        if (Test-Path ".\dist\release.exe") {
          Copy-Item ".\dist\release.exe" ".\release-files\BanGDream-Gacha-v${{ github.ref_name }}.exe"
          Write-Host "âœ“ Copied executable as BanGDream-Gacha-v${{ github.ref_name }}.exe"
        }
        
        # å¤åˆ¶è¯´æ˜æ–‡ä»¶
        @("README.md", "LICENSE") | ForEach-Object {
          if (Test-Path $_) {
            Copy-Item $_ ".\release-files\"
            Write-Host "âœ“ Copied $_"
          }
        }
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        @"
BanG Dream! æŠ½å¡æœŸæœ›æ¨¡æ‹Ÿå™¨ - v${{ github.ref_name }}

æ„å»ºä¿¡æ¯:
- æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
- æºç ç‰ˆæœ¬: ${{ github.sha }}
- Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}
- æ„å»ºç¯å¢ƒ: GitHub Actions (Windows)

ä½¿ç”¨è¯´æ˜:
1. ç›´æ¥è¿è¡Œ BanGDream-Gacha-v${{ github.ref_name }}.exe
2. é¦–æ¬¡è¿è¡Œå¯èƒ½ä¼šè¢« Windows Defender SmartScreen æ‹¦æˆªï¼Œç‚¹å‡»"æ›´å¤šä¿¡æ¯"â†’"ä»è¦è¿è¡Œ"
3. è¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒ README.md

æ³¨æ„: æœ¬ç¨‹åºä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œæ— æ³•å®Œå…¨æ¶ˆé™¤å®‰å…¨è­¦å‘Šã€‚
"@ | Out-File -FilePath ".\release-files\ç‰ˆæœ¬è¯´æ˜.txt" -Encoding UTF8
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: BanG Dream! æŠ½å¡æ¨¡æ‹Ÿå™¨ ${{ github.ref_name }}
        body: |
          ## ğŸ® BanG Dream! æŠ½å¡æœŸæœ›æ¨¡æ‹Ÿå™¨ ${{ github.ref_name }}
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          - ä¸‹è½½ `BanGDream-Gacha-v${{ github.ref_name }}.exe` å¹¶ç›´æ¥è¿è¡Œ
          - Windows 10/11 ç³»ç»Ÿï¼Œæ— éœ€å®‰è£…é¢å¤–ä¾èµ–
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç‚¹å‡»"æ›´å¤šä¿¡æ¯"â†’"ä»è¦è¿è¡Œ"æ¥è·³è¿‡ SmartScreen è­¦å‘Š
          
          ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
          - é«˜æ€§èƒ½è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿï¼ˆæ”¯æŒåƒä¸‡æ¬¡çº§åˆ«æ¨¡æ‹Ÿï¼‰
          - æ”¯æŒ fes æ± ã€æ™®é™æ± ã€å¸¸é©»æ± ç­‰ä¸åŒå¡æ± ç±»å‹
          - å®æ—¶æ˜¾ç¤ºæœŸæœ›æŠ½å¡æ¬¡æ•°ã€ä¸­ä½æ•°ã€90% åˆ†ä½æ•°ç­‰ç»Ÿè®¡æ•°æ®
          - ç¾è§‚çš„å›¾å½¢ç•Œé¢ï¼Œæ”¯æŒé«˜DPIæ˜¾ç¤º
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. è¾“å…¥å½“æœŸ5æ˜Ÿæ–°å¡æ€»æ•°
          2. è®¾ç½®æƒ³è¦æŠ½å–çš„5æ˜Ÿã€4æ˜Ÿæ•°é‡
          3. é€‰æ‹©æ˜¯å¦ä¸ºå¸¸é©»æ± ï¼ˆ50æŠ½ä¿åº•ï¼‰
          4. ç‚¹å‡»"å¼€å§‹æ¨¡æ‹Ÿ"æŸ¥çœ‹ç»“æœ
          
          ### ğŸ“Š æ„å»ºä¿¡æ¯
          - **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
          - **æºç ç‰ˆæœ¬**: `${{ github.sha }}`
          - **Pythonç‰ˆæœ¬**: ${{ env.PYTHON_VERSION }}
          
          ### ğŸ“„ å¼€æºåè®®
          BSD 3-Clause License - è¯¦è§ LICENSE æ–‡ä»¶
        files: |
          release-files/*
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ æ„å»ºå®Œæˆï¼" -ForegroundColor Green
        Write-Host "ğŸ“¦ å‘å¸ƒç‰ˆæœ¬: ${{ github.ref_name }}" -ForegroundColor Cyan
        Write-Host "ğŸ”— Release é¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "ğŸ“‹ æ„å»ºäº§ç‰©:" -ForegroundColor Yellow
        Get-ChildItem ".\release-files\" | ForEach-Object {
          $size = if ($_.PSIsContainer) { "æ–‡ä»¶å¤¹" } else { "$([math]::Round($_.Length/1MB, 2)) MB" }
          Write-Host "  - $($_.Name) ($size)" -ForegroundColor White
        }